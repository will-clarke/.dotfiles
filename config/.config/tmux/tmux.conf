# vim: foldmethod=marker

unbind C-b
bind C-Space send-prefix
set -g prefix C-Space

# Options {{{
set-option -g default-terminal "screen-256color"

# Sensible settings
set-option -s escape-time 0
set-option -g history-limit 50000

# messages are displayed for 4 seconds
set-option -g display-time 4000

# refresh 'status-left' and 'status-right' more often
set-option -g status-interval 5

# emacs key bindings in tmux command prompt (prefix + :) are better than
# vi keys, even for vim users
set-option -g status-keys emacs

# focus events enabled for terminals that support them
set-option -g focus-events on

setw -g mode-keys vi
set-window-option -g mode-keys vi

setw -g mouse on
set -g base-index 1

# Undercurl
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0
# }}}

# Keymaps {{{

# Copy mode {{{
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind P paste-buffer
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
# }}}

bind-key Space last-window
bind Enter copy-mode

# use vim-like keys for splits and windows
bind-key v split-window -h
bind-key s split-window -v

bind-key C-l next-window
bind-key C-h previous-window

bind-key < swap-window -t -1\; select-window -t -1
bind-key > swap-window -t +1\; select-window -t +1

bind-key S choose-tree

bind V send-keys "0v\$"

# bind-key C-p previous-window
# bind-key C-n next-window

bind-key R source-file ~/.config/tmux/tmux.conf \; display-message "~/.config/tmux/tmux.conf reloaded"
# }}}

# Navigation {{{
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n M-h if-shell "$is_vim" "send-keys M-h" "select-pane -L"
bind-key -n M-j if-shell "$is_vim" "send-keys M-j" "select-pane -D"
bind-key -n M-k if-shell "$is_vim" "send-keys M-k" "select-pane -U"
bind-key -n M-l if-shell "$is_vim" "send-keys M-l" "select-pane -R"

bind-key -n 'M-\' if-shell \"$is_vim\" 'send-keys M-\\\\'  'select-pane -l'
bind-key -T copy-mode-vi M-h select-pane -L
bind-key -T copy-mode-vi M-j select-pane -D
bind-key -T copy-mode-vi M-k select-pane -U
bind-key -T copy-mode-vi M-l select-pane -R
bind-key -T copy-mode-vi M-\\ select-pane -l
# }}}

# TPM / Plugins {{{
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-fpp' # prefix-f
set -g @plugin 'tmux-plugins/tmux-urlview' #  prefix-u
set -g @plugin 'tmux-plugins/tmux-open' # copy-mode prefix-o prefix-ctrl-o prefix-ctl-s
set -g @plugin 'tmux-plugins/tmux-prefix-highlight' # For tmux bar at bottom
set -g @plugin 'tmux-plugins/tmux-yank'
# set -g @plugin 'jabirali/tmux-tilish'
# set -g @tilish-navigator 'on'

# Plugin options.
# Install `tpm` if needed.
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Activate the plugins.
run -b "~/.tmux/plugins/tpm/tpm"
# }}}

# TODO: Investigate cool tmux-tilish keyboard shortcuts
# TODO: remove meta-H to switch panek

# Theme
source-file "$HOME/.config/tmux/tokyonight_night.tmux"
